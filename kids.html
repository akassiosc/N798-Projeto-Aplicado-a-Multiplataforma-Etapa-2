<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moda Infantil</title>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link href="styles.css" rel="stylesheet">
    <script src="scripts.js"></script>
    <script type="text/javascript" src="https://npmcdn.com/parse/dist/parse.min.js"></script>
</head>

<body>

    <main class="main">
        <!-- ❀⊱┄┄┄┄┄┄┄┄┄┄┄⊰❀ Nav ❀⊱┄┄┄┄┄┄┄┄┄┄┄⊰❀ -->

        <nav class="navbar navbar-expand-lg navbar-dark">
            <div class="container-fluid">
                <a class="navbar-brand" href="./index.html">iCloset</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse"
                    data-bs-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false"
                    aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                    <div class="navbar-nav ms-auto">
                        <a class="nav-link active" aria-current="page" href="./index.html">Home</a>
                        <a class="nav-link" href="./usuario.html">Cadastro de Cliente</a>
                        <a class="nav-link" href="./login.html">Login</a>
                        <a class="nav-link" href="adm.html">Administração</a>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ❀⊱┄┄┄┄┄┄┄┄┄┄┄⊰❀ Carrossel ❀⊱┄┄┄┄┄┄┄┄┄┄┄⊰❀ -->

        <div id="carouselExampleAutoplaying" class="carousel slide" data-bs-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active">
                    <svg class="bd-placeholder-img bd-placeholder-img-lg d-block w-100" width="800" height="300"
                        xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Third slide"
                        preserveAspectRatio="xMidYMid slice" focusable="false">
                        <title>Moda Infantil</title>
                        <rect width="100%" height="100%" fill="#D83B66"></rect>
                        <image href="./../static/Imagens/placeholders/1 (5).png" x="0" y="0" width="100%"
                            height="100%" />
                        <text class="test" x="20%" y="50%" fill="#fff" dy=".3em">Moda Infantil</text>
                    </svg>
                </div>
                <div class="carousel-item">
                    <svg class="bd-placeholder-img bd-placeholder-img-lg d-block w-100" width="800" height="300"
                        xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Third slide"
                        preserveAspectRatio="xMidYMid slice" focusable="false">
                        <title>Moda Infantil</title>
                        <rect width="100%" height="100%" fill="#D83B66"></rect>
                        <image href="./../static/Imagens/placeholders/1 (6).png" x="0" y="0" width="100%"
                            height="100%" />
                        <text class="test" x="20%" y="50%" fill="#fff" dy=".3em">Moda Infantil</text>
                    </svg>
                </div>
                <div class="carousel-item">
                    <svg class="bd-placeholder-img bd-placeholder-img-lg d-block w-100" width="800" height="300"
                        xmlns="http://www.w3.org/2000/svg" role="img" aria-label="Placeholder: Third slide"
                        preserveAspectRatio="xMidYMid slice" focusable="false">
                        <title>Moda Infantil</title>
                        <rect width="100%" height="100%" fill="#D83B66"></rect>
                        <image href="./../static/Imagens/placeholders/1 (7).png" x="0" y="0" width="100%"
                            height="100%" />
                        <text class="test" x="20%" y="50%" fill="#fff" dy=".3em">Moda Infantil</text>
                    </svg>
                </div>
            </div>
            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleAutoplaying"
                data-bs-slide="prev">
                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Próximo</span>
            </button>
            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleAutoplaying"
                data-bs-slide="next">
                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                <span class="visually-hidden">Anterior</span>
            </button>
        </div>
        
        <hr class="featurette-divider">

        <main class="container my-4">
            <!-- <h2 class="text-center" style="color: #ff69b4;">Moda Infantil</h2> -->
            <div class="row row-cols-1 row-cols-md-2 g-4 product-row" id="productsContainer">
                <!-- Os produtos serão inseridos aqui -->
            </div>
        </main>
    
        <script>
            Parse.initialize("cUiqP0szolC3ZzsWm3pfNtLkmIM4p5fYfCdbFfB0", "Yd9a86a4YWXVpod3ESztWCGGCG62mib4UbhCyB6G");
            Parse.serverURL = 'https://parseapi.back4app.com/';
    
            let id_item;
            async function fetchProducts() {
                const Produto = Parse.Object.extend('Produto');
                const query = new Parse.Query(Produto);
                query.equalTo('categoria', 'Moda Infantil');

                const response = await fetch("http://localhost:3000/product/Moda Infantil", {
                    method: 'GET',
                });

                if (!response.ok) {
                    throw new Error('Erro ao carregar o carrinho');
                }

                const items = await response.json();

                try {
                    const results = await query.find();
                    const productsContainer = document.getElementById('productsContainer');
                    productsContainer.innerHTML = '';

                    const parseResults = results.map(produto => ({
                        id: produto.id,
                        nome: produto.get('nome'),
                        preco: produto.get('preco'),
                    }));

                    const restItems = items.map(item => ({
                        id: item.id_prod,
                        nome: item.nome,
                        preco: item.punit,
                    }));
                    
                const productsWithRestId = results.map(produto => {
                const nome = produto.get('nome'); // Pega o nome do Parse
                const descricao = produto.get('descricao'); // Pega a descrição
                const preco = produto.get('preco'); // Pega o preço
                const fotoRoupaUrl = produto.get('fotoRoupa') ? produto.get('fotoRoupa').url() : ''; // Pega a URL da imagem

                // Encontra o item correspondente na REST API
                const matchingItem = items.find(item => item.nome === nome);
                console.log(matchingItem);

                return {
                    id: produto.id, // ID do Parse
                    nome: nome,
                    descricao: descricao,
                    preco: preco,
                    fotoRoupaUrl: fotoRoupaUrl,
                    restId: matchingItem ? matchingItem.id_prod : 'Não encontrado', // ID da REST API
                };
            });
            
            console.log(productsWithRestId.restId);

            productsWithRestId.forEach((produto) => {
                        const colDiv = document.createElement('div');
                        colDiv.classList.add('col');
                        const cardDiv = document.createElement('div');
                        cardDiv.classList.add('card');
                        cardDiv.innerHTML = `
                            <img src="${produto.fotoRoupaUrl}" class="card-img-top" alt="${produto.nome}">
                            <div class="card-body">
                                <h5 class="card-title">${produto.nome}</h5>
                                <p class="card-text">${produto.descricao}</p>
                                <p class="card-text"><strong>Preço: R$ ${produto.preco.toFixed(2)}</strong></p>
                                <button class="btn btn-primary" onclick="adicionarAoCarrinho(
                ${produto.restId}, 
                '${produto.nome.replace(/'/g, "\\'").replace(/\n/g, ' ')}', 
                '${produto.descricao.replace(/'/g, "\\'").replace(/\n/g, ' ')}', 
                ${produto.preco}, 
                1
            )">Comprar</button>
                            </div>`;
                        colDiv.appendChild(cardDiv);
                        productsContainer.appendChild(colDiv);

                    });
                } catch (error) {
                    console.error('Erro ao buscar produtos:', error);
                }
            }
    

            fetchProducts(); // Chama a função ao carregar a página

        function adicionarAoCarrinho(id_prod, produto, descricao, preco, estoque) {
            console.log('Chama a função')
    // Recupera o ID do cliente armazenado no localStorage
            const id_cliente = localStorage.getItem('clienteId');

            if (!id_cliente) {
                alert('Cliente não identificado. Faça login para adicionar itens ao carrinho.');
                return;
            }

            // Cria o objeto do item a ser adicionado ao carrinho
            const itemCarrinho = {
                id_prod,
                produto,
                descricao,
                preco,
                estoque,
                id_cliente
            };

            // Envia os dados para a REST API (ou localStorage, conforme o caso)
            fetch('http://localhost:3003/carrinho', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'token': localStorage.getItem('token')
                },
                body: JSON.stringify(itemCarrinho),
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro ao adicionar o item ao carrinho');
                    }
                    return response.json();
                })
                .then(data => {
                    alert('Item adicionado ao carrinho com sucesso!');
                    window.location.href = 'carrinho.html';
                    console.log('Resposta da API:', data);
                })
                .catch(error => {
                    console.error('Erro ao adicionar ao carrinho:', error);
                    alert('Não foi possível adicionar o item ao carrinho. Tente novamente.');
                });
        }
        </script>
    
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"></script>

        <hr class="featurette-divider">

        <div class="footer-mor">
            <footer class="footer">
                <p>2024 iCloset. Todos os direitos reservados.</p>
            </footer>
        </div>

    </main>
</body>

</html>